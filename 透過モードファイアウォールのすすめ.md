# 透過モードファイアウォールのすすめ

## 概要

企業ネットワークにおいて、あるサブネット内の一部ホストに対してポート単位のアクセス制御を行いたい場面があります。その際、各ホストに個別ファイアウォールを設定せず、ネットワークレベルで一括制御したいというニーズに応える構成には、次の3つの選択肢があります：

| 方法                    | 概要                           | 利点             | 欠点                              |
| --------------------- | ---------------------------- | -------------- | ------------------------------- |
| **NAT/NAPT方式のルーター導入** | ルーターを経由してプライベートIPアドレスを払い出す構成 | FW適用・アドレス自由度高い | 社内管理とIP不一致、外→内通信制限あり            |
| **透過モードファイアウォール**     | IPを変えずパケットを横取りして制御           | 管理影響なし・導入容易    | 専用機器必要、やや高価                     |
| **同一ネットワーク内のL2接続**    | ホスト群をルーターにぶら下げるだけ            | 接続簡単           | FW効かない（WAN/LAN同一セグメントではL3を通らない） |

以下、それぞれの方式について詳しく解説します。

---

ある企業の社内ネットワークでは、1つのサブネット（例：192.168.0.0/24）内に多数のホストが存在し、すべてに対してグローバルで一元的にIPアドレスが割り振られ、IP重複や未承認アドレスの使用は禁止されています。この環境において、特定のホスト群に対して、特定ポートへのアクセス制御（例えば外部からのSSH遮断や、特定ポートだけ許可）を一括で適用したいというニーズが生じました。

各ホストに個別にファイアウォールを設定するのは管理工数がかかるうえに、設定ミスや保守の手間も大きいため、ネットワーク上で一括して制御したいと考えるのは自然な発想です。

ここで一つの発想として「ルーターを持ち込み、当該ホスト群をそのルーター配下に収容する」という構成が考えられます。具体的には：

* ルーターのWAN側に社内から正式に割り当てられたIPアドレスを設定し、
* LAN側では独自のプライベートアドレス（例：10.10.10.0/24）を自由に割り当て、
* ホスト群はこのLAN側ネットワークに属するように接続、
* ルーターにはNAT（Network Address Translation）機能を有効にし、
* 社内ネットワークへのアクセスをルーター経由とすることで、パケットの通過点でファイアウォール制御を実施する、というものです。

なお、\*\*WANとLANが同一ネットワークに属している場合、ルーターはL3ルーティングを行わず、単なるスイッチのように振る舞うため、ファイアウォール機能が適用されません。\*\*このため、セグメントを明確に分離し、L3を経由する構成にすることが前提となります。

### NATとは

NAT（Network Address Translation）は、内部ネットワークにあるプライベートIPアドレスを持つホストの通信を、ルーターが自身のグローバル（あるいは組織内）IPアドレスに変換して外部に出す技術です。戻ってきた応答パケットは、変換テーブルに従って対応する内部ホストに再配送されます。これにより、

* 外部にはルーター1台しか見えず、内部構成は不可視化され、
* 不正アクセスがあっても、ルーターのファイアウォールで遮断可能となり、
* 内部でプライベートアドレスを自由に運用できる、

といった利点があります。

この構成では、NATとファイアウォールを組み合わせることで、対象ホスト群に対する外部からのアクセス制限を一括で実現できます。実際、家庭用ルーターの多くがこの仕組みでインターネット接続を提供しています。

### NAPTとは

NAPT（Network Address and Port Translation）は、NATをさらに拡張し、IPアドレスだけでなく**ポート番号も同時に変換する方式**です。1つのグローバルIPアドレスを使って、複数の内部ホストが同時に通信できるようにするために、NAPTではポート番号の変換も行います。

例えば、

* 192.168.0.2:12345 → 203.0.113.1:61001
* 192.168.0.3:12345 → 203.0.113.1:61002

のように、同じ送信元ポートを持つ複数ホストでも、グローバル側のポート番号を分けることで識別します。これにより、**家庭や企業内の多数の端末が、1つのグローバルIPで同時にインターネット通信できる**ようになります。

### NAT/NAPTは通常意識しなくても適用されている

ほとんどの家庭用ルーターや中小企業向けルーターでは、NATおよびNAPTは**初期設定の段階で自動的に有効化されており、利用者が意識して設定する必要はありません**。WANポートをインターネットに接続し、LANポートに端末を接続するだけで、裏側ではNAT/NAPTによるアドレス変換とポート変換が行われ、通信が成立します。

ただし、外部から内部への通信（外→内通信）を許可したい場合は、ポートフォワーディング（DNAT）の設定や、DMZ、UPnPなどの追加設定が必要です。

### しかしNATでは解決できない問題もある

NATの最大の弱点は、**内部ホストのIPアドレスが変わってしまう**ことにあります。社内で利用されている資産管理システムや監視ソリューションが、ホストのIPアドレスをキーにしている場合、

* 元の社内IPアドレス（例：192.168.0.101）でなく、
* ルーターのWAN側IP（例：192.168.0.150）しか見えなくなるため、
* 資産追跡やイベントログの突合が困難になる、

といった運用上の問題が発生します。つまり、ネットワーク的には目的を達成できても、運用面で致命的な支障が出る可能性があります。

### 解決策：透過モードファイアウォール

そこで有効なのが「透過モード（Transparent Mode）」で動作するファイアウォール機器の導入です。これは、L2（レイヤー2）のスイッチのように動作しながら、パケットをすべて検査し、指定ルールに基づいて許可・拒否を行うものです。

この方式では：

* 対象ホストは社内ネットワークのIPをそのまま使用可能（IP変更なし）、
* 透過モードファイアウォールは、物理的にホスト群の前段に設置するだけでOK、
* ルーティングやNATを行わず、パケットの内容に応じたフィルタリングが可能、
* 資産管理システムや監視ログにも影響を与えない、

という大きな利点があります。

この方式を実現するには、家庭用ルーターではなく、

* FortiGate や Cisco ASA などのエンタープライズ向けファイアウォール、
* pfSense / OPNsense などのOSSファイアウォールを搭載した小型PC、
* MikroTik、Ubiquiti など中小向けルーター機器、
  などを選定する必要があります。

### 日本国内で入手可能な透過モード対応ファイアウォール製品

#### 1. ヤマハ UTX100

* 特徴：ヤマハ製のUTMファイアウォールで、ブリッジモードに対応。L2MSスレーブ機能により、ヤマハルーターのLANマップによる機器管理が可能。
* 価格：約134,200円（税込）
* 詳細：[https://network.yamaha.com/products/firewalls/utx100/license](https://network.yamaha.com/products/firewalls/utx100/license)

#### 2. D-Link DBG-X1000

* 特徴：Wi-Fi 6対応のUTMファイアウォールで、クラウド型ネットワーク管理サービス「Nuclias Cloud」に対応。ステートフルインスペクション、IDP/IPS、Webコンテンツフィルタリング、アプリケーション制御などの機能を備える。
* 価格：約52,580円（税込）
* 詳細：[https://nttxstore.jp/\_II\_DL16616781](https://nttxstore.jp/_II_DL16616781)

#### 3. SonicWall TZシリーズ (Gen7)

* 特徴：デスクトップモデルながら10GbE/5GbEのインターフェイスを搭載した次世代ファイアウォール。ステートフルパケットインスペクション、DDoS防御、VPN機能などを備える。
* 価格：モデルや構成により異なる。販売店に問い合わせ。
* 詳細：[https://online.plathome.co.jp/SonicWALL/UTM/](https://online.plathome.co.jp/SonicWALL/UTM/)

### おわりに

NATは便利で手軽ですが、IPアドレスを隠蔽するという副作用があるため、社内ネットワークとの親和性が求められる場面では適しません。一方、透過モードファイアウォールは、既存のIPアドレス体系や監視運用に影響を与えずに、特定ホスト群に対する高度なアクセス制御を可能にします。

「一部のホストだけ守りを強化したい。でも全体構成は変えたくない」──そんなときこそ、透過モードファイアウォールの出番です。
